<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Bloom √ó Miller ‚Äì Compet√™ncias e Avalia√ß√£o</title>
  <style>
    :root{
      --bg:#0f172a;/*slate-900*/
      --panel:#111827;/*gray-900*/
      --muted:#94a3b8;/*slate-400*/
      --text:#e5e7eb;/*gray-200*/
      --acc:#22c55e;/*green-500*/
      --chip:#1f2937;/*gray-800*/
      --chip2:#0ea5e9;/*sky-500*/
      --warn:#f59e0b;/*amber-500*/
      --danger:#ef4444;/*red-500*/
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1224, #0f172a 30%, #0f172a);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size:22px;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted)}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .controls{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:10px}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text)}
    .btn{cursor:pointer;border:none;padding:10px 14px;border-radius:12px;font-weight:600}
    .btn-primary{background:var(--acc);color:#06240f}
    .btn-ghost{background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.12)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{padding:4px 10px;border-radius:999px;background:var(--chip);font-size:12px;border:1px solid rgba(255,255,255,.06)}
    .chip[data-type="Miller"]{background:rgba(14,165,233,.15);border-color:rgba(14,165,233,.35)}
    .grid{display:grid;grid-template-columns: 1.2fr 1.1fr 1.6fr .9fr 1.2fr 1.8fr 1.6fr 1.6fr;gap:8px;align-items:flex-start}
    .th,.td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.07)}
    .th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .row:hover{background:rgba(255,255,255,.03)}
    .table{overflow:auto}
    .badge{display:inline-block;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:700}
    .bloom-remember{background:#0b3b8a33;border:1px solid #60a5fa;color:#93c5fd}
    .bloom-understand{background:#0b8a3b33;border:1px solid #34d399;color:#86efac}
    .bloom-apply{background:#8a6c0b33;border:1px solid #f59e0b;color:#fde68a}
    .bloom-analyze{background:#7a0b8a33;border:1px solid #a78bfa;color:#ddd6fe}
    .bloom-evaluate{background:#8a0b0b33;border:1px solid #f87171;color:#fecaca}
    .bloom-create{background:#0b8a8a33;border:1px solid #22d3ee;color:#a5f3fc}
    .footer{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px}
    .mini{font-size:12px;color:var(--muted)}
    .kpi{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0}
    .k{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px}
    .k b{font-size:18px}
    .vis{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px}
    .bar{background:linear-gradient(90deg,var(--chip2),#22c55e);height:10px;border-radius:999px}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:16px 0}
    .planilha{white-space:pre;font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0b1220;border-radius:12px;border:1px solid rgba(255,255,255,.08);padding:12px;overflow:auto;max-height:260px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .charts{display:grid;grid-template-columns:1.5fr 1fr;gap:16px;margin-top:8px}
    .chart-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
    canvas{width:100%;height:260px;display:block}
    .chart-title{font-size:13px;color:var(--muted);margin:0 0 8px 2px}
    .tests{background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px;margin-top:10px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Dashboard Bloom √ó Miller ‚Äì exemplos pr√°ticos e instrumentos</div>
        <div class="subtitle">Alinhamento construtivo: objetivo ‚Üî m√©todo ‚Üî avalia√ß√£o ‚Üî rubrica</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none" />
        <button id="btnImport" class="btn btn-ghost">Importar CSV</button>
        <button id="btnTemplate" class="btn btn-ghost">Baixar modelo CSV</button>
        <button id="btnDownloadCSV" class="btn btn-primary">Baixar planilha (CSV)</button>
        <button id="btnReset" class="btn btn-ghost">Limpar filtros</button>
        <button id="btnTests" class="btn btn-ghost">Executar testes</button>
      </div>
    </header>

    <section class="card">
      <div class="controls">
        <input id="q" type="search" placeholder="üîé Buscar texto (ex.: ‚Äògasometria‚Äô, ‚ÄòOSCE‚Äô, ‚Äòempatia‚Äô)" />
        <select id="fBloom">
          <option value="">Filtrar por n√≠vel de Bloom</option>
          <option>Lembrar</option>
          <option>Compreender</option>
          <option>Aplicar</option>
          <option>Analisar</option>
          <option>Avaliar</option>
          <option>Criar</option>
        </select>
        <select id="fDim">
          <option value="">Filtrar por dimens√£o do conhecimento</option>
          <option>Factual</option>
          <option>Conceitual</option>
          <option>Procedimental</option>
          <option>Metacognitivo</option>
        </select>
        <select id="fMiller">
          <option value="">Filtrar por n√≠vel de Miller</option>
          <option>sabe</option>
          <option>sabe como</option>
          <option>mostra como</option>
          <option>faz</option>
        </select>
        <select id="fCurso">
          <option value="">Filtrar por √°rea</option>
          <option>Enfermagem</option>
          <option>Medicina</option>
          <option>Fisioterapia</option>
          <option>Multiprofissional</option>
          <option>Direito</option>
        </select>
        <select id="fRisco">
          <option value="">Risco/impacto</option>
          <option>Alto</option>
          <option>M√©dio</option>
          <option>Baixo</option>
        </select>
        <select id="fCSV">
          <option value="full" selected>CSV: conjunto</option>
          <option value="filtered">CSV: filtrado</option>
        </select>
      </div>
      <div class="kpi" id="kpi"></div>
      <div class="charts">
        <div class="chart-card">
          <div class="chart-title">Distribui√ß√£o por n√≠veis de Bloom (Barra)</div>
          <canvas id="chartBloom"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Distribui√ß√£o por n√≠veis de Miller (Pizza)</div>
          <canvas id="chartMiller"></canvas>
        </div>
      </div>
      <div class="table" id="table"></div>
      <div class="footer">
        <div class="mini">Dica: clique nos cabe√ßalhos para ordenar ‚Ä¢ Use busca + filtros para focar no seu cen√°rio ‚Ä¢ A tabela √© o ‚Äúblueprint de bolso‚Äù.</div>
      </div>
      <div id="importMsg" class="mini" style="margin-top:6px"></div>
      <div id="testOutput" class="tests" style="display:none"></div>
    </section>

    <div class="sep"></div>

    <section class="card">
      <h3 style="margin:0 0 8px 0">Planilha CSV (pr√©-visualiza√ß√£o)</h3>
      <div id="csvPreview" class="planilha"></div>
      <div class="hint">Esta √© a planilha base. Voc√™ pode baix√°-la, abrir no Excel/Sheets e continuar editando.</div>
    </section>
  </div>

<script>
// ===================== DADOS =====================
let rows = [
  // ===== √ÅREA SA√öDE ‚Äì Multiprofissional / Medicina / Enfermagem / Fisioterapia =====
  {bloom:'Lembrar', dim:'Factual', objetivo:'Listar sinais vitais e valores de refer√™ncia em adultos', contexto:'unidade de cl√≠nica m√©dica', criterio:'acerto ‚â• 90% em tabela', miller:'sabe', instrumento:'M√∫ltipla escolha (MCQ/SBA)', exemplo:'Qual o intervalo normal da press√£o arterial sist√≥lica?', evidencia:'Gabarito + an√°lise de distratores', curso:'Multiprofissional', risco:'Baixo'},
  {bloom:'Compreender', dim:'Conceitual', objetivo:'Explicar o racional do protocolo de higiene das m√£os', contexto:'enfermaria', criterio:'menciona 5 momentos e impacto em IRAS', miller:'sabe', instrumento:'Quest√£o discursiva curta', exemplo:'Explique por que a higiene das m√£os reduz IRAS.', evidencia:'Rubrica 0‚Äì2 (exatid√£o, clareza, evid√™ncia)', curso:'Multiprofissional', risco:'M√©dio'},

  {bloom:'Aplicar', dim:'Procedimental', objetivo:'Calcular dose de medica√ß√£o por peso', contexto:'pediatria', criterio:'erro absoluto < 10%', miller:'sabe como', instrumento:'Itens-chave (Key-features) / Resposta curta (SAQ)', exemplo:'Crian√ßa 12kg, Amoxicilina 50mg/kg/dia‚Ä¶ calcule a dose.', evidencia:'C√°lculo correto + justificativa', curso:'Medicina', risco:'Alto'},
  {bloom:'Aplicar', dim:'Procedimental', objetivo:'Executar t√©cnica de comunica√ß√£o terap√™utica (SPIKES) em m√°s not√≠cias', contexto:'ambulat√≥rio oncol√≥gico simulado', criterio:'todos os itens cr√≠ticos cumpridos', miller:'mostra como', instrumento:'OSCE ‚Äì paciente padronizado', exemplo:'Conduza comunica√ß√£o de diagn√≥stico oncol√≥gico inicial.', evidencia:'Checklist cr√≠tico + avalia√ß√£o global ancorada', curso:'Enfermagem', risco:'Alto'},

  {bloom:'Analisar', dim:'Conceitual', objetivo:'Interpretar gasometria arterial em DPOC exacerbado', contexto:'pronto atendimento', criterio:'classifica dist√∫rbio √°cido‚Äìb√°sico corretamente', miller:'sabe como', instrumento:'Caso estruturado', exemplo:'GA: pH 7,28; PaCO2 60; HCO3- 28‚Ä¶ interprete.', evidencia:'Justificativa + pr√≥ximos passos', curso:'Medicina', risco:'Alto'},
  {bloom:'Analisar', dim:'Metacognitivo', objetivo:'Monitorar vi√©s de ancoragem ao priorizar diagn√≥sticos de dor tor√°cica', contexto:'sala de caso', criterio:'declara hip√≥tese rival + dado disconfirmador', miller:'sabe como', instrumento:'Itens-chave (Key-features) + reflex√£o', exemplo:'Qual dado mais amea√ßou sua hip√≥tese inicial?', evidencia:'Reflex√£o guiada 2‚Äì3 linhas', curso:'Medicina', risco:'M√©dio'},

  {bloom:'Avaliar', dim:'Conceitual', objetivo:'Justificar prioriza√ß√£o do bundle de sepse na 1¬™ hora', contexto:'emerg√™ncia', criterio:'ordena interven√ß√µes por impacto/tempo', miller:'sabe como', instrumento:'Caso com justificativa', exemplo:'Ordene e justifique as 5 primeiras a√ß√µes.', evidencia:'Rubrica anal√≠tica (prioriza√ß√£o)', curso:'Multiprofissional', risco:'Alto'},
  {bloom:'Avaliar', dim:'Metacognitivo', objetivo:'Calibrar confian√ßa cl√≠nica frente a dados amb√≠guos', contexto:'discuss√£o de caso', criterio:'autoestima 0‚Äì100% coerente com evid√™ncia', miller:'sabe como', instrumento:'MCQ + confian√ßa', exemplo:'Marque a resposta e o n√≠vel de confian√ßa.', evidencia:'√çndice de calibra√ß√£o', curso:'Medicina', risco:'M√©dio'},

  {bloom:'Criar', dim:'Procedimental', objetivo:'Elaborar plano de alta com educa√ß√£o ao paciente e fam√≠lia', contexto:'cl√≠nica m√©dica', criterio:'ensino por teach-back + seguran√ßa de medicamentos', miller:'mostra como', instrumento:'OSCE de alta hospitalar', exemplo:'Explique alta de paciente com IC descompensada.', evidencia:'Avalia√ß√£o global ancorada + itens cr√≠ticos', curso:'Enfermagem', risco:'Alto'},
  {bloom:'Criar', dim:'Conceitual', objetivo:'Adaptar protocolo institucional para realidade local', contexto:'UBS', criterio:'mant√©m princ√≠pios e viabilidade', miller:'faz', instrumento:'Projeto + portf√≥lio', exemplo:'Adapte fluxo de rastreio de HAS para UBS rural.', evidencia:'Produto + valida√ß√£o do servi√ßo', curso:'Multiprofissional', risco:'M√©dio'},

  {bloom:'Aplicar', dim:'Procedimental', objetivo:'Realizar pun√ß√£o venosa perif√©rica com seguran√ßa', contexto:'enfermaria', criterio:'2 tentativas m√°x.; assepsia adequada', miller:'mostra como', instrumento:'OSCE/DOPS', exemplo:'Pun√ß√£o em simulador adulto.', evidencia:'Checklist cr√≠tico + tempo', curso:'Enfermagem', risco:'Alto'},
  {bloom:'Aplicar', dim:'Procedimental', objetivo:'Administrar insulina de corre√ß√£o corretamente', contexto:'leito', criterio:'dose correta + checagem dupla', miller:'faz', instrumento:'Mini-CEX no servi√ßo', exemplo:'Aplica√ß√£o em paciente DM em uso de sliding scale.', evidencia:'Observa√ß√£o direta + feedback', curso:'Enfermagem', risco:'Alto'},
  {bloom:'Analisar', dim:'Conceitual', objetivo:'Interpretar ECG inicial em dor tor√°cica', contexto:'emerg√™ncia', criterio:'reconhece supra ST e indica√ß√µes', miller:'sabe como', instrumento:'Caso + gabarito comentado', exemplo:'ECG com supra II, III, aVF‚Ä¶ conduta?', evidencia:'Justificativa + pr√≥xima a√ß√£o', curso:'Medicina', risco:'Alto'},
  {bloom:'Avaliar', dim:'Procedimental', objetivo:'Auditar qualidade de registros de enfermagem', contexto:'unidade cl√≠nica', criterio:'‚â• 90% campos essenciais completos', miller:'faz', instrumento:'Auditoria + checklist', exemplo:'Revisar 10 prontu√°rios consecutivos.', evidencia:'Planilha com indicadores', curso:'Enfermagem', risco:'M√©dio'},
  {bloom:'Criar', dim:'Metacognitivo', objetivo:'Planejar e ajustar estrat√©gia de atendimento em cen√°rio de alta demanda', contexto:'pronto-socorro', criterio:'define prioridades e gatilhos de mudan√ßa', miller:'faz', instrumento:'Portf√≥lio reflexivo + CbD', exemplo:'Como reorganizou o fluxo em pico de demanda?', evidencia:'Reflex√£o + valida√ß√£o do preceptor', curso:'Multiprofissional', risco:'Alto'},
  {bloom:'Compreender', dim:'Conceitual', objetivo:'Descrever princ√≠pios do consentimento informado', contexto:'ambulat√≥rio', criterio:'inclui riscos, benef√≠cios e alternativas', miller:'sabe', instrumento:'MCQ/SAQ', exemplo:'Elementos obrigat√≥rios do consentimento?', evidencia:'Gabarito comentado', curso:'Medicina', risco:'M√©dio'},
  {bloom:'Lembrar', dim:'Factual', objetivo:'Enumerar etapas do paramenta√ß√£o e desparamenta√ß√£o', contexto:'controle de infec√ß√£o', criterio:'ordem correta 100%', miller:'sabe', instrumento:'MCQ sequencial', exemplo:'Qual a sequ√™ncia correta para EPI?', evidencia:'Chave ilustrada', curso:'Multiprofissional', risco:'Alto'},
  {bloom:'Avaliar', dim:'Conceitual', objetivo:'Criticar uma prescri√ß√£o quanto a intera√ß√µes', contexto:'cl√≠nica m√©dica', criterio:'identifica intera√ß√µes clinicamente relevantes', miller:'sabe como', instrumento:'Caso com prontu√°rio', exemplo:'Avalie esta prescri√ß√£o de alta.', evidencia:'Rubrica de seguran√ßa medicamentosa', curso:'Medicina', risco:'Alto'},

  // ===== FISIOTERAPIA =====
  {bloom:'Aplicar', dim:'Procedimental', objetivo:'Executar manobra de reexpans√£o pulmonar com t√©cnica adequada', contexto:'UTI adulto simulada', criterio:'comando ventilat√≥rio + monitoriza√ß√£o SpO2', miller:'mostra como', instrumento:'OSCE respirat√≥rio (avalia√ß√£o global ancorada)', exemplo:'Realize ciclo de AFE em paciente com atelectasia', evidencia:'Checklist cr√≠tico + avalia√ß√£o global ancorada', curso:'Fisioterapia', risco:'Alto'},
  {bloom:'Analisar', dim:'Conceitual', objetivo:'Interpretar espirometria b√°sica (VEF1, CVF, rela√ß√£o)', contexto:'ambulat√≥rio de pneumologia', criterio:'classifica dist√∫rbio ventilat√≥rio corretamente', miller:'sabe como', instrumento:'Caso + gr√°ficos', exemplo:'VEF1 55%, CVF 80%, rela√ß√£o 0,6 ‚Äì diagn√≥stico?', evidencia:'Justificativa + conduta', curso:'Fisioterapia', risco:'M√©dio'},
  {bloom:'Criar', dim:'Procedimental', objetivo:'Elaborar plano de reabilita√ß√£o de marcha p√≥s-AVE', contexto:'cl√≠nica escola', criterio:'metas SMART + progress√£o segura', miller:'faz', instrumento:'Plano + portf√≥lio', exemplo:'Programe 4 semanas de treino com √≥rtese AFO', evidencia:'Reavalia√ß√£o + metas atingidas', curso:'Fisioterapia', risco:'Alto'},

  // ===== DIREITO =====
  {bloom:'Lembrar', dim:'Factual', objetivo:'Enumerar elementos essenciais do contrato de compra e venda', contexto:'Direito Civil I', criterio:'‚â• 90% de acerto', miller:'sabe', instrumento:'M√∫ltipla escolha (MCQ/SBA)', exemplo:'Quais s√£o os elementos essenciais?', evidencia:'Gabarito + distratores', curso:'Direito', risco:'Baixo'},
  {bloom:'Analisar', dim:'Conceitual', objetivo:'Analisar caso de responsabilidade civil m√©dica', contexto:'estudo de caso escrito', criterio:'identifica nexo, culpa e dano', miller:'sabe como', instrumento:'Caso estruturado/parecer', exemplo:'Paciente alega erro em alta hospitalar‚Ä¶', evidencia:'Rubrica anal√≠tica (fundamenta√ß√£o jur√≠dica)', curso:'Direito', risco:'M√©dio'},
  {bloom:'Avaliar', dim:'Conceitual', objetivo:'Sustentar tese em audi√™ncia simulada (contradit√≥rio e ampla defesa)', contexto:'moot court', criterio:'coer√™ncia, pertin√™ncia e uso de precedentes', miller:'mostra como', instrumento:'Simula√ß√£o/OSCE jur√≠dico', exemplo:'Sustenta√ß√£o oral em agravo de instrumento', evidencia:'Avalia√ß√£o global ancorada + checklist de argumentos', curso:'Direito', risco:'Alto'},
  {bloom:'Criar', dim:'Procedimental', objetivo:'Redigir pe√ßa processual completa e adequada ao caso', contexto:'N√∫cleo de Pr√°tica Jur√≠dica (NPJ)', criterio:'endere√ßamento correto, pedidos e fundamentos', miller:'faz', instrumento:'Portf√≥lio + avalia√ß√£o do supervisor', exemplo:'Inicial de indeniza√ß√£o por danos morais', evidencia:'Produto revisado + feedback 360¬∫', curso:'Direito', risco:'Alto'}
];

// ===================== RENDER TABELA =====================
const headers = [
  {key:'bloom', label:'Bloom'},
  {key:'dim', label:'Dimens√£o'},
  {key:'objetivo', label:'Objetivo (formato observ√°vel)'},
  {key:'miller', label:'Miller'},
  {key:'instrumento', label:'Instrumento'},
  {key:'exemplo', label:'Exemplo de item/tarefa'},
  {key:'evidencia', label:'Evid√™ncia/Rubrica'},
  {key:'contexto', label:'Contexto'}
];

// Colunas do CSV (inclui √°rea e risco no final)
const CSV_COLS = ['Bloom','Dimens√£o','Objetivo','Miller','Instrumento','Exemplo','Evid√™ncia/Rubrica','Contexto','√Årea','Risco'];

let sortKey = 'bloom';
let sortDir = 1;

function bloomBadge(b){
  const map={
    'Lembrar':'bloom-remember',
    'Compreender':'bloom-understand',
    'Aplicar':'bloom-apply',
    'Analisar':'bloom-analyze',
    'Avaliar':'bloom-evaluate',
    'Criar':'bloom-create'
  };
  return `<span class="badge ${map[b]||''}">${b}</span>`
}

function renderTable(){
  const q = document.getElementById('q').value.toLowerCase();
  const fB = document.getElementById('fBloom').value;
  const fD = document.getElementById('fDim').value;
  const fM = document.getElementById('fMiller').value;
  const fC = document.getElementById('fCurso').value;
  const fR = document.getElementById('fRisco').value;

  let data = rows.filter(r=>
    (!fB || r.bloom===fB) &&
    (!fD || r.dim===fD) &&
    (!fM || r.miller===fM) &&
    (!fC || r.curso===fC) &&
    (!fR || r.risco===fR) &&
    (q==='' || Object.values(r).join(' ').toLowerCase().includes(q))
  );

  data.sort((a,b)=> (a[sortKey] > b[sortKey] ? 1 : -1) * sortDir);

  const head = `<div class="grid">${headers.map(h=>`<div class=\"th\" role=\"button\" onclick=\"setSort('${h.key}')\">${h.label}</div>`).join('')}</div>`;
  const body = data.map(r=>`<div class=\"grid row\">\n      <div class=\"td\">${bloomBadge(r.bloom)}<div class=\"chips\"><span class=\"chip\">${r.curso}</span><span class=\"chip\">Risco: ${r.risco}</span></div></div>\n      <div class=\"td\">${r.dim}</div>\n      <div class=\"td\">${r.objetivo}</div>\n      <div class=\"td\"><span class=\"chip\" data-type=\"Miller\">${r.miller}</span></div>\n      <div class=\"td\">${r.instrumento}</div>\n      <div class=\"td\">${r.exemplo}</div>\n      <div class=\"td\">${r.evidencia}</div>\n      <div class=\"td\">${r.contexto}</div>\n    </div>`).join('');
  document.getElementById('table').innerHTML = head + body;

  // KPIs e CHARTS (com base no filtro atual)
  const byMiller = ['sabe','sabe como','mostra como','faz'].map(m=>({m, n:data.filter(x=>x.miller===m).length }));
  const byBloom = ['Lembrar','Compreender','Aplicar','Analisar','Avaliar','Criar'].map(b=>({b, n:data.filter(x=>x.bloom===b).length }));

  const kpi = `
    <div class=\"k\"><div>Registros (filtrados)</div><b>${data.length}</b></div>
    <div class=\"k\"><div>Miller (amostragem)</div>
      <div class=\"vis\">${byMiller.map(x=>`<div title=\"${x.m}\"><div style=\"font-size:12px;color:var(--muted)\">${x.m}</div><div class=\"bar\" style=\"width:${(x.n/Math.max(1,data.length))*100}%\"></div></div>`).join('')}</div>
    </div>
    <div class=\"k\"><div>Bloom (distribui√ß√£o)</div>
      <div class=\"vis\" style=\"grid-template-columns:repeat(6,1fr)\">${byBloom.map(x=>`<div title=\"${x.b}\"><div style=\"font-size:12px;color:var(--muted)\">${x.b}</div><div class=\"bar\" style=\"width:${(x.n/Math.max(1,data.length))*100}%\"></div></div>`).join('')}</div>
    </div>`;
  document.getElementById('kpi').innerHTML = kpi;

  renderCharts(byBloom, byMiller);

  // Pr√©via do CSV: sempre TODOS os registros, conforme prefer√™ncia do usu√°rio
  document.getElementById('csvPreview').textContent = toCSV(rows);
}

function setSort(k){
  if(sortKey===k){ sortDir*=-1 } else { sortKey=k; sortDir=1 }
  renderTable();
}

['q','fBloom','fDim','fMiller','fCurso','fRisco','fCSV'].forEach(id=>{
  document.getElementById(id).addEventListener('input', renderTable)
});

document.getElementById('btnReset').addEventListener('click', ()=>{
  ['q','fBloom','fDim','fMiller','fCurso','fRisco'].forEach(id=> document.getElementById(id).value='');
  renderTable();
});

// ===================== CSV =====================
function toCSV(data){
  const lines = data.map(r=>[
    r.bloom, r.dim, r.objetivo, r.miller, r.instrumento, r.exemplo, r.evidencia, r.contexto, r.curso, r.risco
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  return [CSV_COLS.join(','), ...lines].join('\n');
}

function refreshCSVPreview(){
  document.getElementById('csvPreview').textContent = toCSV(rows);
}

function downloadCSV(){
  // Download sempre com TODOS os registros (prefer√™ncia confirmada)
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'dashboard_bloom_miller.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById('btnDownloadCSV').addEventListener('click', downloadCSV);

// ======== IMPORTA√á√ÉO CSV ========
function detectSep(line){
  const comma=(line.match(/,/g)||[]).length; const semi=(line.match(/;/g)||[]).length; return semi>comma?';':',';
}
function parseCSVText(text){
  text=text.replace(/\r\n?/g,'\n').trim(); if(!text) return {headers:[], rows:[]};
  const sep = detectSep(text.split('\n')[0]||',');
  const out=[]; let row=[], field='', inQ=false; const pushField=()=>{row.push(field); field=''}; const pushRow=()=>{out.push(row); row=[]};
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch==='"') { if(inQ && next==='"'){ field+='"'; i++; } else { inQ=!inQ; } }
    else if(ch===sep && !inQ){ pushField(); }
    else if(ch==='\n' && !inQ){ pushField(); pushRow(); }
    else { field+=ch; }
  }
  if(field.length>0 || row.length>0){ pushField(); pushRow(); }
  const headers=out.shift()||[]; return {headers, rows:out};
}
function normalize(s){ return String(s||'').trim().toLowerCase(); }
const HEADER_MAP = {
  'bloom':'bloom','dimens√£o':'dim','dimensao':'dim','objetivo':'objetivo','miller':'miller','instrumento':'instrumento','exemplo':'exemplo','evid√™ncia/rubrica':'evidencia','evidencia/rubrica':'evidencia','contexto':'contexto','√°rea':'curso','area':'curso','risco':'risco'
};
function importCSVFromText(text){
  const {headers:h, rows:r} = parseCSVText(text);
  if(!h.length){ return showImportMsg('Arquivo vazio ou cabe√ßalho ausente.', true); }
  const mapIdx = h.map((name,idx)=>({idx, key: HEADER_MAP[normalize(name)]||null, raw:name}));
  const required=['bloom','dim','objetivo','miller','instrumento','exemplo','evidencia','contexto','curso','risco'];
  const missing = required.filter(k=> !mapIdx.some(m=>m.key===k));
  if(missing.length){
    return showImportMsg('Cabe√ßalho incompat√≠vel. Faltando: '+missing.join(', ')+'. Use o bot√£o "Baixar modelo CSV".', true);
  }
  const newRows = r.map(arr=>{
    const obj={};
    mapIdx.forEach(m=>{ if(m.key){ obj[m.key] = arr[m.idx]??''; } });
    return obj;
  });
  if(!newRows.length){ return showImportMsg('Nenhuma linha de dados encontrada.', true); }
  rows = newRows; // substitui dataset
  renderTable(); refreshCSVPreview();
  showImportMsg('Importa√ß√£o conclu√≠da: '+rows.length+' registros carregados.');
}
function showImportMsg(msg, isErr=false){
  const el=document.getElementById('importMsg'); if(!el) return; el.style.color = isErr?'#fecaca':'#94a3b8'; el.textContent = msg;
}

document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('csvFile').click());

document.getElementById('csvFile').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f){ return; }
  const reader = new FileReader(); reader.onload = ()=> importCSVFromText(reader.result); reader.readAsText(f);
});

document.getElementById('btnTemplate').addEventListener('click', ()=>{
  const header = CSV_COLS.join(',');
  const example = 'Lembrar,Factual,"Exemplo de objetivo","sabe","M√∫ltipla escolha (MCQ/SBA)","Enuncie X‚Ä¶","Gabarito","contexto","Multiprofissional","Baixo"';
  const blob = new Blob([header+'\n'+example], {type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='modelo_dashboard_bloom_miller.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// ======== CHARTS (canvas puro, sem libs) ========
function drawBarChart(canvas, labels, values, colors){
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio||1; const W = canvas.clientWidth*dpr; const H = canvas.clientHeight*dpr;
  canvas.width=W; canvas.height=H; ctx.clearRect(0,0,W,H);
  const pad = 32*dpr; const max = Math.max(1, ...values);
  const bw = (W - pad*2) / Math.max(1, labels.length) * 0.7; // bar width
  labels.forEach((lab,i)=>{
    const x = pad + i*((W - pad*2)/Math.max(1,labels.length)) + (((W - pad*2)/Math.max(1,labels.length))-bw)/2;
    const h = (H - pad*2) * (values[i]/max);
    const y = H - pad - h;
    ctx.fillStyle = colors[i % colors.length];
    const r = 8*dpr; // rounded bar
    const w=bw; const rr=Math.min(r, h/2, w/2);
    ctx.beginPath();
    ctx.moveTo(x, y+rr);
    ctx.arcTo(x, y, x+rr, y, rr);
    ctx.lineTo(x+w-rr, y);
    ctx.arcTo(x+w, y, x+w, y+rr, rr);
    ctx.lineTo(x+w, y+h);
    ctx.lineTo(x, y+h);
    ctx.closePath();
    ctx.fill();
    // label value
    ctx.fillStyle = 'rgba(229,231,235,.9)';
    ctx.font = `${12*dpr}px system-ui`;
    ctx.textAlign='center';
    if(values[i]>0) ctx.fillText(values[i], x+w/2, y-6*dpr);
    // x label
    ctx.fillStyle='rgba(148,163,184,.9)';
    ctx.font = `${11*dpr}px system-ui`;
    ctx.fillText(lab, x+w/2, H - pad/2);
  });
}

function drawPieChart(canvas, labels, values, colors){
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio||1; const W = canvas.clientWidth*dpr; const H = canvas.clientHeight*dpr;
  canvas.width=W; canvas.height=H; ctx.clearRect(0,0,W,H);
  const cx = W/2, cy = H/2; const r = Math.min(W,H)/2 - 24*dpr;
  const total = Math.max(1, values.reduce((a,b)=>a+b,0));
  let start = -Math.PI/2;
  values.forEach((v,i)=>{
    const ang = (v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i % colors.length];
    ctx.arc(cx,cy,r,start,start+ang);
    ctx.closePath(); ctx.fill();
    start += ang;
  });
  // legend
  const lw = 12*dpr; const lh = 12*dpr; let lx = 16*dpr, ly = 16*dpr;
  labels.forEach((lab,i)=>{
    ctx.fillStyle=colors[i % colors.length]; ctx.fillRect(lx, ly, lw, lh);
    ctx.fillStyle='rgba(229,231,235,.9)'; ctx.font=`${12*dpr}px system-ui`;
    ctx.fillText(`${lab} (${values[i]})`, lx+lw+8*dpr, ly+lh);
    ly += lh + 8*dpr;
  });
}

function renderCharts(byBloom, byMiller){
  const bloomCanvas = document.getElementById('chartBloom');
  const millerCanvas = document.getElementById('chartMiller');
  const bloomLabels = byBloom.map(x=>x.b);
  const bloomValues = byBloom.map(x=>x.n);
  const bloomColors = ['#60a5fa','#34d399','#f59e0b','#a78bfa','#f87171','#22d3ee'];
  drawBarChart(bloomCanvas, bloomLabels, bloomValues, bloomColors);

  const millerLabels = byMiller.map(x=>x.m);
  const millerValues = byMiller.map(x=>x.n);
  const millerColors = ['#38bdf8','#22c55e','#eab308','#ef4444'];
  drawPieChart(millerCanvas, millerLabels, millerValues, millerColors);
}

window.addEventListener('resize', ()=>{ renderTable(); });

// ===================== TESTES (sanidade) =====================
function runTests(){
  const out = [];
  try{
    renderTable();
    const tableHTML = document.getElementById('table').innerHTML;
    out.push(tableHTML.includes('grid') ? '‚úî Tabela renderizada' : '‚úñ Tabela vazia');

    const csv = toCSV(rows.slice(0,2));
    const firstLine = csv.split('\n')[0];
    out.push(firstLine === CSV_COLS.join(',') ? '‚úî Cabe√ßalho CSV correto' : '‚úñ Cabe√ßalho CSV incorreto');

    const blob = new Blob([toCSV(rows.slice(0,1))], {type:'text/csv'});
    out.push(blob.size > 0 ? '‚úî Blob CSV gerado' : '‚úñ Blob CSV vazio');

    document.getElementById('fMiller').value = 'faz';
    renderTable();
    const filteredCount = rows.filter(x=>x.miller==='faz').length;
    out.push(filteredCount >= 1 ? '‚úî Filtro Miller (faz) retornou registros' : '‚úñ Filtro Miller (faz) vazio (ver base)');
    document.getElementById('fMiller').value = '';

    const cb = document.getElementById('chartBloom');
    out.push(cb.width>0 && cb.height>0 ? '‚úî Canvas gr√°fico dimensionado' : '‚úñ Canvas n√£o dimensionado');

  }catch(e){
    out.push('‚úñ Erro durante testes: '+ e.message);
  }
  const el = document.getElementById('testOutput');
  el.style.display='block';
  el.textContent = out.join('\n');
  renderTable();
}

document.getElementById('btnTests').addEventListener('click', runTests);

// ===== init =====
renderTable();
refreshCSVPreview();
</script>
</body>
</html>
